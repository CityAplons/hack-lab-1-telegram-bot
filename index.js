"use strict";
const {readFileSync} = require('fs')
const {Telegraf} = require('telegraf')
const {
    Extra,
    Markup,
    Stage
  } = Telegraf
const {MenuTemplate, MenuMiddleware, createBackMainMenuButtons} = require('telegraf-inline-menu')
const LocalSession = require('telegraf-session-local')

const bot = new Telegraf("TG_TOKEN")

/*
 * User local database
 */
bot.use((new LocalSession({ database: '_users_db.json' })).middleware())

/*
 * Scenes (Quest, Buildings)
 */
const SceneGenerator = require('./scenes')
const curScene = new SceneGenerator()
const questScene = curScene.genQuestScene()
const boolQuestScene = curScene.genBoolQuestScene()
const luckScene = curScene.genluckScene()

const stage = new Stage([questScene, boolQuestScene, luckScene])
stage.command('home', async (ctx) => {
    await ctx.scene.leave()
    ctx.reply('–í—ã –≤–µ—Ä–Ω—É–ª–∏—Å—å –¥–æ–º–æ–π')
    menuMiddleware.replyToContext(ctx)
})
bot.use(stage.middleware())

/*
 * User interface
 */

const menuTemplate = new MenuTemplate(ctx => `
üëã–ü—Ä–∏–≤–µ—Ç, –∫–∞–ø–∏—Ç–∞–ª–∏—Å—Ç!
üí™–•–æ—á–µ—à—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–≤–æ–∏ –∑–Ω–∞–Ω–∏—è –≤ —Ñ–∏–Ω–∞–Ω—Å–∞—Ö –∏ —É–∑–Ω–∞—Ç—å –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–µ —Ñ–∞–∫—Ç—ã?  
‚õîÔ∏è–ù–µ –±–æ–∏—à—å—Å—è –æ—Å—Ç–∞—Ç—å—Å—è –Ω–∏ —Å —á–µ–º?
üí∞–ì–æ—Ç–æ–≤ –∑–∞ –∫–æ—Ä–æ—Ç–∫–∏–π —Å—Ä–æ–∫ —Å—Ç–∞—Ç—å –º–∏–ª–ª–∏–æ–Ω–µ—Ä–æ–º?

–ï—Å–ª–∏ –¥–∞, —Ç–æ —ç—Ç–∞ –∏–≥—Ä–∞ –¥–ª—è —Ç–µ–±—è! 
üëÄ–ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ /instructions `)

//States
let mainMenuToggle = false
let luckButtonToggle = false
let statsMenuToggle = false

/*
 * Player data
 */
const fields = JSON.parse(readFileSync('_data_db.json'));
const levelFields = fields.levels
const baselFields = fields.bases
const investFields = fields.invests
/*
 * Statistics submenu
 */
const statsMenu = new MenuTemplate((ctx) => {
    return `–¢–æ–∫–µ–Ω—ã: ${ctx.session.coinsAmount.toFixed(3)}üü°\n–ú–µ—Å—Ç–æ —Ä–∞–±–æ—Ç—ã: ${baselFields[ctx.session.base].name}\n–ë–æ–Ω—É—Å–Ω—ã–π –º–Ω–æ–∂–∏—Ç–µ–ª—å: ${ctx.session.base}\n–¢–≤–æ–π —É—Ä–æ–≤–µ–Ω—å: ${ctx.session.level} -> ${levelFields[ctx.session.level].role}
${levelFields[ctx.session.level].description}`;
})
statsMenu.manualRow(createBackMainMenuButtons("–ù–∞–∑–∞–¥", "–í –º–µ–Ω—é"))
menuTemplate.submenu('–ü—Ä–æ–≥—Ä–µ—Å—Å', 'amount', statsMenu, {
	hide: () => mainMenuToggle
})

/*
 * Upgrade base submenu
 */
const upgradeMenu = new MenuTemplate((ctx) => {
    return `–û–±–Ω–æ–≤–∏—Ç—å —Ä–∞–±–æ—á–µ–µ –º–µ—Å—Ç–æ - ${baselFields[ctx.session.base+1].name} ${baselFields[ctx.session.base+1].price}üü°`;
})
upgradeMenu.interact('–ö—É–ø–∏—Ç—å', 'buyUpgradeBase', {
    do: async ctx => {
        if(ctx.session.coinsAmount >= baselFields[ctx.session.base+1].price) {
            ctx.session.coinsAmount -= baselFields[ctx.session.base+1].price
            ctx.session.base += 1
            ctx.reply(`–í—ã –ø–µ—Ä–µ—Ö–∞–ª–∏ –≤ ${baselFields[ctx.session.base].name}!`)
        } else {
            ctx.reply(`–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç —Ç–æ–∫–µ–Ω–æ–≤! üò°`)
        }
    
        return true;
    }
})
upgradeMenu.manualRow(createBackMainMenuButtons("–ù–∞–∑–∞–¥", "–í –º–µ–Ω—é"))
statsMenu.submenu('–û–±–Ω–æ–≤–∏—Ç—å —Ä–∞–±–æ—á–µ–µ –º–µ—Å—Ç–æ', 'upgradeBase', upgradeMenu, {
	hide: () => statsMenuToggle
})

/*
 * Upgrade timer submenu
 */
const upgradeTimerMenu = new MenuTemplate((ctx) => {
    let startupsString = ""
    for (let index = ctx.session.counterLevel; index > 0; index--) {
        startupsString += `${investFields[index].name}; `;
    }
    return `–£–≤–µ–ª–∏—á–∏—Ç—å –ø—Ä–∏–±—ã–ª—å, –ø—Ä–æ–∏–Ω–≤–µ—Å—Ç–∏—Ä–æ–≤–∞–≤ –≤ "${investFields[ctx.session.counterLevel+1].name}" ${investFields[ctx.session.counterLevel+1].price*Math.pow(5,ctx.session.base)}üü°\n–ü—Ä–∏–±—ã–ª—å —É–≤–µ–ª–∏—á–∏—Ç—Å—è –Ω–∞ ${investFields[ctx.session.counterLevel+1].rate*Math.pow(5,ctx.session.base)} üü° –≤ —Å–µ–∫.
–¢–µ–∫—É—â–∏–µ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏: ${startupsString} –ü—Ä–∏–±—ã–ª—å ${(investFields[ctx.session.counterLevel+1].rate+1)*Math.pow(5,(ctx.session.base))} üü° –≤ —Å–µ–∫.`;
})
upgradeTimerMenu.interact('–ò–Ω–≤–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å', 'buyUpgradeTimer', {
    do: async ctx => {
        if(ctx.session.coinsAmount >= investFields[ctx.session.counterLevel+1].price*Math.pow(5,ctx.session.base)) {
            ctx.session.coinsAmount -= investFields[ctx.session.counterLevel+1].price*Math.pow(5,ctx.session.base)
            ctx.session.counterLevel += 1
            ctx.reply(`–í—ã –∏–Ω–≤–µ—Å—Ç–∏—Ä–æ–≤–∞–ª–∏ –≤ ${investFields[ctx.session.counterLevel].name}, —Ç–µ–ø–µ—Ä—å –∑–∞—Ä–∞–±–æ—Ç–æ–∫ –Ω–∞ ${investFields[ctx.session.counterLevel].rate*Math.pow(5,ctx.session.base)}üü° –≤ —Å–µ–∫. —Ä–∞–∑ –≤—ã—à–µ!`)
        } else {
            ctx.reply(`–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç —Ç–æ–∫–µ–Ω–æ–≤! üò°`)
        }
    
        return true;
    }
})
upgradeTimerMenu.manualRow(createBackMainMenuButtons("–ù–∞–∑–∞–¥", "–í –º–µ–Ω—é"))
statsMenu.submenu('–ò–Ω–≤–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å', 'upgradeTimer', upgradeTimerMenu, {
	hide: () => statsMenuToggle
})

/*
 * Play submenu
 */
const playMenu = new MenuTemplate(ctx => {
    return `–í–∞—à –±–∞–ª–∞–Ω—Å: ${ctx.session.coinsAmount.toFixed(3)}üü°\nüïπüéÆ–í—ã–±–µ—Ä–∏—Ç–µ –∏–≥—Ä–æ–≤–æ–π —Ä–µ–∂–∏–º –∏ –∑–∞–ø–ª–∞—Ç–∏—Ç–µ –∑–∞ —É—á–∞—Å—Ç–∏–µ –∏–∑ —Å–≤–æ–µ–≥–æ –∫–∞—Ä–º–∞–Ω–∞üí∏!\n‚ùì‚ùì–í–æ–ø—Ä–æ—Å: 150üü°\nüü¢üî¥–ü—Ä–∞–≤–¥–∞ –∏–ª–∏ –õ–æ–∂—å: 10üü°\nüéØüé≤–ò—Å–ø—ã—Ç–∞—Ç—å —Ñ–æ—Ä—Ç—É–Ω—É: –¥–æ—Å—Ç—É–ø–Ω–æ 1 —Ä–∞–∑ –≤ –¥–µ–Ω—åüï∞ –°—Ç–æ–∏–º–æ—Å—Ç—å ${200*ctx.session.level}üü°`
})
playMenu.interact('–í–æ–ø—Ä–æ—Å—ã', 'quest', {
    do: async ctx => {
        if (ctx.session.coinsAmount >= 150) {
            await ctx.reply(`–ß—Ç–æ–±—ã –æ—Ç–≤–µ—á–∞—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã, –ø–∏—à–∏—Ç–µ —á–∏—Å–ª–∞ –æ—Ç 1 –¥–æ 4. \n–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /home –¥–ª—è –≤—ã—Ö–æ–¥–∞ –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é`)
            ctx.scene.enter('quest')
        } else {
            await ctx.reply("–ù–µ —Ö–≤–∞—Ç–∞—Ç–µ—Ç üü°")
        }
        return true;
    }
})
playMenu.interact('–ü—Ä–∞–≤–¥–∞/–õ–æ–∂—å', 'boolQuest', {
    do: async ctx => {
        if (ctx.session.coinsAmount >= 10) {
            await ctx.reply(`–ß—Ç–æ–±—ã –æ—Ç–≤–µ—á–∞—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã, –æ—Ç–≤–µ—á–∞–π—Ç–µ –î–∞ –∏–ª–∏ –ù–µ—Ç. \n–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /home –¥–ª—è –≤—ã—Ö–æ–¥–∞ –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é`)
            ctx.scene.enter('boolQuest')
        } else {
            await ctx.reply("–ù–µ —Ö–≤–∞—Ç–∞—Ç–µ—Ç üü°")
        }
        return true;
    }
})
playMenu.interact('–ò—Å–ø—ã—Ç–∞—Ç—å —Ñ–æ—Ä—Ç—É–Ω—É', 'luck', {
    hide: () => {
        if (luckButtonToggle) return true 
        else return false;
    },
    do: async ctx => {
        if (ctx.session.coinsAmount >= 200*ctx.session.level) {
            luckButtonToggle = true
            ctx.scene.enter('luck')
        } else {
            await ctx.reply("–ù–µ —Ö–≤–∞—Ç–∞—Ç–µ—Ç üü°")
        }
        
        return true;
    }
})
playMenu.manualRow(createBackMainMenuButtons("–ù–∞–∑–∞–¥", "–í –º–µ–Ω—é"))
menuTemplate.submenu('–ò–≥—Ä–∞—Ç—å', 'play', playMenu, {
	hide: () => mainMenuToggle
})

/*
 * Level progression
 */
bot.use(async (ctx, next) => {
    //Level
    if (ctx.session.level) {
        if(ctx.session.wins >= levelFields[ctx.session.level].wins && ctx.session.base >= 1) {
            ctx.session.level += 1
            ctx.reply(`üéâ –í–∞—à —É—Ä–æ–≤–µ–Ω—å –≤—ã—Ä–æ—Å! –¢–µ–ø–µ—Ä—å –≤—ã ${levelFields[ctx.session.level].role} üéâ`)
            ctx.session.wins = 0
        }
    }
    //Timer
    if (ctx.session.lastVision) {
        let add = (new Date() - new Date(ctx.session.lastVision))/1000
        add += (investFields[ctx.session.counterLevel+1].rate+1)*add*Math.pow(5,(ctx.session.base))
        if(!isNaN(add)) ctx.session.coinsAmount += add
        ctx.session.wins += add
        ctx.session.lastVision = new Date();
    }
    //Lower than 0
    if (ctx.session.coinsAmount < 0) {
        ctx.session.coinsAmount = 0
    }
    //Luck timer
    if ((new Date() - new Date(ctx.session.lastLuckRun)) >= 24*60*60*1000) luckButtonToggle = false
    else luckButtonToggle = true
    return next();
})

/*
 * Bot reactions
 */
const menuMiddleware = new MenuMiddleware('/', menuTemplate)
bot.command('start', ctx => {
    ctx.session.coinsAmount = ctx.session.coinsAmount || 10;
    ctx.session.wins = ctx.session.wins || 0;
    ctx.session.base = ctx.session.base || 0;
    ctx.session.level = ctx.session.level || 1;
    ctx.session.counterLevel = ctx.session.counterLevel || 0;
    ctx.session.lastVision = ctx.session.lastVision || new Date();
    ctx.session.lastLuckRun = ctx.session.lastLuckRun || new Date();
    ctx.session.restart_quest = true
    ctx.session.restart_tf = true
    menuMiddleware.replyToContext(ctx)
})
bot.use(menuMiddleware)
bot.command('instructions',(ctx) => ctx.reply(`–í —ç—Ç–æ–π –∏–≥—Ä–µ —Ç–µ–±–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ—Ç–≤–µ—á–∞—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã, –∑–∞—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –¥–µ–Ω—å–≥–∏ –∏ —Ä–∞–∑–≤–∏–≤–∞—Ç—å —Å–≤–æ–π –±–∏–∑–Ω–µ—Å!
–î–ª—è –Ω–æ–≤–æ–≥–æ —É—Ä–æ–≤–Ω—è –Ω—É–∂–Ω–æ –∑–∞—Ä–∞–±–æ—Ç–∞—Ç—å ${levelFields[ctx.session.level].wins - ctx.session.wins}üü°`))
bot.on('sticker', (ctx) => ctx.reply('üëç'))
bot.hears('–ø—Ä–∏–≤–µ—Ç', (ctx) => ctx.reply('–ù—É –∑–¥–∞—Ä–æ–≤–∞, –º–µ—á–µ–Ω–Ω—ã–π'))
bot.launch()